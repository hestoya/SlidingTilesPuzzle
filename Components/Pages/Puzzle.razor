@page "/puzzle"
@rendermode InteractiveServer

@using SlidingTilesPuzzle.Components.Puzzle
@using SlidingTilesPuzzle.Models
@using SlidingTilesPuzzle.Services
@inject PuzzleService Puzzles
@inject ImageService Images
@inject NavigationManager Navigation

<h3>Sliding Puzzle</h3>
<p>Moves Counter: @Moves</p>

<button class="refresh-btn" @onclick="NewGame">
    New Game
</button>

<div class="puzzle-layout">
    <ReferenceImage ImageUrl="@ImageUrl" />

    <div class="board-wrapper" tabindex="0">
        <PuzzleBoard Tiles="Tiles"
                     ImageUrl="@ImageUrl"
                     OnTileClick="MoveTile" />

        <WinOverlay Visible="IsSolved"
                    Moves="Moves"
                    OnRetry="Reshuffle"
                    OnNew="NewGame" />
    </div>
</div>

@code {
    List<Tile> Tiles = [];
    string ImageUrl = "";
    int Moves;
    bool IsSolved;

    protected override void OnInitialized() => StartPuzzle();

    void NewGame()
    {
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }

    void StartPuzzle()
    {
        ImageUrl = Images.GenerateImageUrl();
        Tiles = Puzzles.CreateTiles();
        Puzzles.ShuffleSolvable(Tiles);
        Moves = 0;
        IsSolved = false;
    }

    void Reshuffle()
    {
        Puzzles.ShuffleSolvable(Tiles);
        Moves = 0;
        IsSolved = false;
    }

    void MoveTile(Tile tile)
    {
        if (IsSolved) return;

        var empty = Tiles.First(t => t.IsEmpty);
        if (!Puzzles.CanMove(tile, empty)) return;

        (tile.CurrentIndex, empty.CurrentIndex) =
        (empty.CurrentIndex, tile.CurrentIndex);

        Moves++;
        IsSolved = Puzzles.IsSolved(Tiles);
    }
}
